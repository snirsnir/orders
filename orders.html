<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת הזמנות - דף ראשי</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --pending: #6b7280;
            --explanation-needed: #d4755d;
            --explanation-received: #3b82f6;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-primary: #60a5fa;
            --accent-hover: #3b82f6;
            --border-color: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            --gradient: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            --success: #059669;
            --warning: #d97706;
            --error: #dc2626;
            --pending: #6b7280;
            --explanation-needed: #d9cb06;
            --explanation-received: #3b82f6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo-text p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            border-color: var(--accent-primary);
            transform: scale(1.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            border: 1px solid var(--border-color);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .main-content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .welcome-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-primary);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .action-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .action-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .orders-table-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .filter-btn:hover {
            border-color: var(--accent-primary);
        }

        .search-filters {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: none;
        }

        .search-filters.active {
            display: block;
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-item {
            display: flex;
            flex-direction: column;
        }

        .search-item label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .search-item input,
        .search-item select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .search-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
        }

        .orders-table th,
        .orders-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .orders-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }

        .order-row {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .order-row:hover {
            background: var(--bg-tertiary);
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending {
            background: #f3f4f6;
            color: var(--pending);
        }

        .status-partial {
            background: #fef3c7;
            color: var(--warning);
        }

        .status-approved {
            background: #d1fae5;
            color: var(--success);
        }

        .status-rejected {
            background: #fee2e2;
            color: var(--error);
        }

        .status-explanation-needed {
            background: #eeea0b;
            color: var(--explanation-needed);
        }

        .billing-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .billing-onetime {
            background: #e0f2fe;
            color: #0277bd;
        }

        .billing-monthly {
            background: #fff3e0;
            color: #ef6c00;
        }

        .billing-yearly {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .approval-status {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .approval-item {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .approval-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .approval-pending {
            background: var(--pending);
        }

        .approval-approved {
            background: var(--success);
        }

        .approval-explanation_needed {
            background: var(--explanation-needed);
        }

        .approval-explanation_received {
            background: var(--explanation-received);
        }

        .approval-explanation-received {
            background: var(--explanation-received);
        }
        
        .approval-explanation-needed {
            background: var(--explanation-needed);
        }

        .expand-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
        }

        .expand-btn:hover {
            background: var(--accent-hover);
        }

        .receipt-btn {
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
        }

        .upload-receipt-btn {
            background: var(--success);
            color: white;
        }

        .upload-receipt-btn:hover {
            background: #059669;
        }

        .view-receipt-btn {
            background: var(--warning);
            color: white;
        }

        .view-receipt-btn:hover {
            background: #d97706;
        }

        .manage-receipts-btn {
            background: var(--accent-primary);
            color: white;
        }

        .manage-receipts-btn:hover {
            background: var(--accent-hover);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .receipt-modal-content {
            max-width: 800px;
            width: 95%;
        }

        .receipt-viewer {
            text-align: center;
            margin-bottom: 1rem;
        }

        .receipt-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .receipt-pdf {
            width: 100%;
            height: 500px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .file-upload {
            margin: 1rem 0;
        }

        .file-input {
            display: none;
        }

        .file-upload-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-upload-btn:hover {
            background: var(--accent-hover);
        }

        .download-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .download-btn:hover {
            background: #059669;
        }

        .print-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-left: 1rem;
        }

        .print-btn:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .billing-section {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            border: 1px solid var(--border-color);
        }

        .billing-options {
            display: flex;
            gap: 2rem;
            margin: 1rem 0;
        }

        .billing-radio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .billing-radio input[type="radio"] {
            margin: 0;
        }

        .billing-sub-options {
            margin-left: 2rem;
            margin-top: 1rem;
            display: none;
        }

        .billing-sub-options.active {
            display: block;
        }

        .billing-schedule {
            margin-top: 1rem;
            display: none;
        }

        .billing-schedule.active {
            display: block;
        }

        .receipts-list {
            margin-top: 1rem;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .receipt-info {
            flex-grow: 1;
        }

        .receipt-actions {
            display: flex;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-small {
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .explanation-section {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid var(--explanation-needed);
        }

        .explanation-text {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .reply-section {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 4px solid var(--explanation-received);
        }

        .reply-text {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .print-order {
            display: none;
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
            
            * {
                visibility: hidden;
                background: transparent !important;
                color: black !important;
                box-shadow: none !important;
                text-shadow: none !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            .print-order,
            .print-order * {
                visibility: visible !important;
            }
            
            .print-order {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: fit-content !important;
                max-height: calc(297mm - 20mm) !important;
                display: block !important;
                font-family: Arial, sans-serif !important;
                font-size: 10px !important;
                line-height: 1.1 !important;
                overflow: hidden !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            
            .print-section {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-bottom: 6px !important;
            }
            
            .print-order table {
                width: 100% !important;
                border-collapse: collapse !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-bottom: 6px !important;
            }
            
            .print-order th,
            .print-order td {
                border: 1px solid black !important;
                padding: 3px !important;
                font-size: 9px !important;
                background: transparent !important;
                vertical-align: top !important;
            }
            
            .print-order th {
                background: #f0f0f0 !important;
                font-weight: bold !important;
                font-size: 8px !important;
            }
            
            .print-order .signature-approved {
                color: #0066cc !important;
                font-weight: bold !important;
            }
            
            .print-order h2 {
                font-size: 14px !important;
                margin: 0 0 10px 0 !important;
            }
            
            .print-order h3 {
                font-size: 11px !important;
                margin: 6px 0 4px 0 !important;
                padding: 2px !important;
            }
            
            .print-order p {
                margin: 3px 0 !important;
                font-size: 9px !important;
            }
            
            body {
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
            }
            
            html, body {
                height: 100% !important;
                overflow: hidden !important;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 0 1rem;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .orders-table-container {
                overflow-x: auto;
            }

            .filter-buttons {
                flex-wrap: wrap;
            }

            .search-grid {
                grid-template-columns: 1fr;
            }

            .billing-options {
                flex-direction: column;
                gap: 1rem;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toggle-search-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-left: 1rem;
        }

        .toggle-search-btn:hover {
            background: var(--accent-hover);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">📋</div>
                <div class="logo-text">
                    <h1>מערכת הזמנות</h1>
                    <p id="userRole">טוען...</p>
                </div>
            </div>
            <div class="user-section">
                <button class="theme-toggle" id="themeToggle">
                    <span id="themeIcon">🌙</span>
                </button>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">👤</div>
                    <span id="userName">טוען...</span>
                </div>
                <button class="logout-btn" id="logoutBtn">יציאה</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <section class="welcome-section fade-in">
            <h2 class="welcome-title" id="welcomeTitle">טוען...</h2>
            <p class="welcome-subtitle" id="welcomeSubtitle">ניהול חכם של הזמנות וציוד</p>
        </section>

        <section class="action-buttons fade-in" id="actionButtons">
        </section>

        <section class="orders-table-container fade-in" id="ordersTableContainer">
            <div class="table-header">
                <h3 class="table-title" id="tableTitle">ההזמנות שלי</h3>
                <div class="filter-buttons" id="filterButtons">
                    <button class="filter-btn active" data-filter="all">הכל</button>
                    <button class="filter-btn" data-filter="pending">בהמתנה</button>
                    <button class="filter-btn" data-filter="approved">מאושר</button>
                    <button class="filter-btn" data-filter="rejected">נדחה</button>
                    <button class="toggle-search-btn" id="toggleSearchBtn">🔍 חיפוש מתקדם</button>
                </div>
            </div>
            
            <!-- Search and filter section for approvers -->
            <div class="search-filters" id="searchFilters">
                <div class="search-grid">
                    <div class="search-item">
                        <label>חיפוש כללי</label>
                        <input type="text" id="generalSearch" placeholder="חפש לפי שם מוצר או מספר הזמנה...">
                    </div>
                    <div class="search-item">
                        <label>שם המזמין</label>
                        <input type="text" id="requesterSearch" placeholder="שם המזמין...">
                    </div>
                    <div class="search-item">
                        <label>סעיף תקציבי</label>
                        <select id="departmentFilter">
                            <option value="">כל המחלקות</option>
                            <option value="תכנית בוקר">תכנית בוקר</option>
                            <option value="מחוננים">מחוננים</option>
                            <option value="ניהול">ניהול</option>
                            <option value="IT">מחלקת מחשבים</option>
                            <option value="תחזוקה">תחזוקה</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>
                    <div class="search-item">
                        <label>סכום מינימלי</label>
                        <input type="number" id="minAmount" placeholder="₪0" step="0.01">
                    </div>
                    <div class="search-item">
                        <label>סכום מקסימלי</label>
                        <input type="number" id="maxAmount" placeholder="₪999999" step="0.01">
                    </div>
                    <div class="search-item">
                        <label>תאריך מ-</label>
                        <input type="date" id="fromDate">
                    </div>
                    <div class="search-item">
                        <label>תאריך עד</label>
                        <input type="date" id="toDate">
                    </div>
                    <div class="search-item">
                        <label>סוג חיוב</label>
                        <select id="billingTypeFilter">
                            <option value="">כל סוגי החיוב</option>
                            <option value="onetime">חד פעמי</option>
                            <option value="monthly">חודשי</option>
                            <option value="yearly">שנתי</option>
                        </select>
                    </div>
                </div>
                <div class="search-actions">
                    <button class="btn btn-secondary btn-small" id="clearFiltersBtn">נקה סינון</button>
                    <button class="btn btn-primary btn-small" id="applyFiltersBtn">החל סינון</button>
                </div>
            </div>

            <div id="ordersTableContent">
                <div style="overflow-x: auto;">
                    <table class="orders-table">
<thead>
    <tr>
        <th>תאריך</th>
        <th id="requesterNameHeader" style="display: none;">שם</th>
        <th>הזמנה מס</th>
        <th>סעיף תקציבי</th>
        <th>חיוב</th>
        <th>סה"כ</th>
        <th>סטטוס</th>
        <th id="emailColumnHeader">שלח מייל</th>
        <th>אישורים</th>
        <th>פעולות</th>
    </tr>
</thead>
                        <tbody id="ordersTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">📋</div>
                    <h3>אין הזמנות להצגה</h3>
                    <p>התחל ביצירת הזמנה חדשה</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal for new order -->
    <div class="modal" id="newOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">יצירת הזמנה חדשה</h2>
                <button class="modal-close" id="closeNewOrderModal">&times;</button>
            </div>
            <form id="newOrderForm">
                <div class="form-group">
                    <label class="form-label">שם המזמין</label>
                    <input type="text" class="form-input" id="requesterName" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">תאריך</label>
                    <input type="date" class="form-input" id="orderDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">סעיף תקציבי</label>
                    <select class="form-select" id="department" required>
                        <option value="">בחר מחלקה</option>
                        <option value="תכנית בוקר">תכנית בוקר</option>
                        <option value="מחוננים">מחוננים</option>
                        <option value="ניהול">ניהול</option>
                        <option value="IT">מחלקת מחשבים</option>
                        <option value="תחזוקה">תחזוקה</option>
                        <option value="אחר">אחר</option>
                    </select>
                </div>

                <!-- Billing Section -->
                <div class="billing-section">
                    <h4>סוג חיוב</h4>
                    <div class="billing-options">
                        <label class="billing-radio">
                            <input type="radio" name="billingType" value="onetime" checked>
                            <span>חיוב חד פעמי</span>
                        </label>
                        <label class="billing-radio">
                            <input type="radio" name="billingType" value="recurring">
                            <span>חיוב רב פעמי</span>
                        </label>
                    </div>
                    
                    <div class="billing-sub-options" id="recurringOptions">
                        <h5>תדירות חיוב</h5>
                        <div class="billing-options">
                            <label class="billing-radio">
                                <input type="radio" name="recurringType" value="monthly">
                                <span>חודשי</span>
                            </label>
                            <label class="billing-radio">
                                <input type="radio" name="recurringType" value="yearly">
                                <span>שנתי</span>
                            </label>
                        </div>
                    </div>

                    <div class="billing-schedule" id="billingSchedule">
                        <div class="form-group">
                            <label class="form-label">מועד חיוב ראשון</label>
                            <input type="date" class="form-input" id="firstBillingDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">מספר חיובים (אופציונלי)</label>
                            <input type="number" class="form-input" id="billingCount" min="1" placeholder="השאר ריק לחיוב רציף">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">הערות להזמנה (אופציונלי)</label>
                    <textarea class="form-textarea" id="orderNotes" placeholder="הוסף הערות למאשרים אם נדרש..."></textarea>
                </div>

                <div id="orderItems">
                    <h3 style="margin-bottom: 1rem;">פריטי ההזמנה</h3>
                    <div class="order-item" data-item="0">
                        <div class="form-group">
                            <label class="form-label">שם המוצר ותיאור</label>
                            <input type="text" class="form-input" name="productName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">מטרה - תיאור הצורך</label>
                            <textarea class="form-textarea" name="purpose" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">כמות קיימת במלאי</label>
                            <input type="number" class="form-input" name="stockQuantity" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">שם הספק</label>
                            <input type="text" class="form-input" name="supplier" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">עלות בש"ח כולל מע"מ</label>
                            <input type="number" class="form-input cost-input" name="cost" step="0.01" min="0" required>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin: 1rem 0;">
                    <button type="button" class="btn btn-secondary" id="addItemBtn">+ הוסף פריט</button>
                </div>

                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h4>סיכום הזמנה</h4>
                    <p>סה"כ לא כולל מע"מ: <span id="totalExcludingVat">₪0</span></p>
                    <p>סה"כ כולל מע"מ: <span id="totalIncludingVat">₪0</span></p>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="sendEmailNotification" style="margin: 0;">
                            <span>🔔 שלח מייל למאשרים </span>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelOrderBtn">ביטול</button>
                    <button type="submit" class="btn btn-primary" id="submitOrderBtn">
                        <span>שלח הזמנה לאישור</span>
                        <div class="loading" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for order details -->
    <div class="modal" id="orderDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">פרטי הזמנה</h2>
                <div>
                    <button class="print-btn" id="printOrderBtn">🖨️ הדפס</button>
                    <button class="modal-close" id="closeOrderDetailsModal">&times;</button>
                </div>
            </div>
            <div id="orderDetailsContent">
            </div>
        </div>
    </div>

    <!-- Modal for receipt -->
    <div class="modal" id="receiptModal">
        <div class="modal-content receipt-modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="receiptModalTitle">קבלה</h2>
                <button class="modal-close" id="closeReceiptModal">&times;</button>
            </div>
            <div id="receiptContent">
            </div>
        </div>
    </div>

    <!-- Modal for managing multiple receipts -->
    <div class="modal" id="receiptsManagementModal">
        <div class="modal-content receipt-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ניהול קבלות</h2>
                <button class="modal-close" id="closeReceiptsManagementModal">&times;</button>
            </div>
            <div id="receiptsManagementContent">
                <div class="form-group">
                    <label class="form-label">תאריך חיוב</label>
                    <input type="date" class="form-input" id="receiptDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">הערות (אופציונלי)</label>
                    <input type="text" class="form-input" id="receiptNotes" placeholder="הערות על החיוב...">
                </div>
                <div class="file-upload">
                    <input type="file" id="newMultipleReceiptFile" class="file-input" accept="image/*,.pdf">
                    <label for="newMultipleReceiptFile" class="file-upload-btn">
                        📁 בחר קבלה
                    </label>
                    <button class="btn btn-primary" id="addReceiptBtn" style="margin-left: 1rem; display: none;">
                        ➕ הוסף קבלה
                    </button>
                </div>
                
                <div class="receipts-list" id="receiptsList">
                    <h4>קבלות קיימות</h4>
                    <div id="existingReceipts"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for explanation -->
    <div class="modal" id="explanationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="explanationModalTitle">דרוש הסבר</h2>
                <button class="modal-close" id="closeExplanationModal">&times;</button>
            </div>
            <div id="explanationContent">
                <div class="form-group">
                    <label class="form-label">הסבר למזמין למה ההזמנה לא אושרה:</label>
                    <textarea class="form-textarea" id="explanationText" placeholder="כתוב כאן את ההסבר למזמין..." required></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="cancelExplanationBtn">ביטול</button>
                    <button class="btn btn-warning" id="sendExplanationBtn">שלח הסבר</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for reply -->
    <div class="modal" id="replyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">הגב למאשר</h2>
                <button class="modal-close" id="closeReplyModal">&times;</button>
            </div>
            <div id="replyContent">
                <div class="form-group">
                    <label class="form-label">הגב למאשר עם ההסבר הנדרש:</label>
                    <textarea class="form-textarea" id="replyText" placeholder="כתוב כאן את התגובה למאשר..." required></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="cancelReplyBtn">ביטול</button>
                    <button class="btn btn-primary" id="sendReplyBtn">שלח תגובה</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for reminder -->
    <div class="modal" id="reminderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">שלח מייל</h2>
                <button class="modal-close" id="closeReminderModal">&times;</button>
            </div>
            <div id="reminderContent">
                <div class="form-group">
                    <label class="form-label">בחר למי לשלוח תזכורת:</label>
                    <div id="approversList"></div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn btn-secondary" id="cancelReminderBtn">ביטול</button>
                    <button class="btn btn-primary" id="sendReminderBtn">שלח מייל</button>
                </div>
            </div>
        </div>
    </div>

    <div class="print-order" id="printOrderContent">
    </div>

    <!-- EmailJS Script -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getDatabase, ref, set, get, push, onValue, query, orderByChild, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

        // אתחול EmailJS
        (function() {
            emailjs.init("pEUlg7PtCjfrf1NYh");
        })();

        const firebaseConfig = {
            apiKey: "AIzaSyDpsIEhz1DExRgvzx3on3RMxtY9stIA4us",
            authDomain: "oreders-ef40d.firebaseapp.com",
            databaseURL: "https://oreders-ef40d-default-rtdb.firebaseio.com/",
            projectId: "oreders-ef40d",
            storageBucket: "oreders-ef40d.firebasestorage.app",
            messagingSenderId: "313770368508",
            appId: "1:313770368508:web:f1445553df848f59a32679"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        let currentUser = null;
        let userRole = null;
        let userData = null;
        let orders = [];
        let filteredOrders = [];
        let itemCounter = 0;
        let currentOrderId = null;
        let currentApproverKey = null;
        let currentReminderOrderId = null;

        // מערך המיילים של המאשרים
        const approverEmails = {
            'emily': 'emily@technoda.org.il',
            'shuli': 'shuli@technoda.org.il', 
            'gadi': 'gadi1@technoda.org.il'
        };

        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const userRoleElement = document.getElementById('userRole');
        const welcomeTitle = document.getElementById('welcomeTitle');
        const welcomeSubtitle = document.getElementById('welcomeSubtitle');
        const actionButtons = document.getElementById('actionButtons');
        const tableTitle = document.getElementById('tableTitle');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const emptyState = document.getElementById('emptyState');
        const filterButtons = document.getElementById('filterButtons');
        const newOrderModal = document.getElementById('newOrderModal');
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const receiptModal = document.getElementById('receiptModal');
        const receiptsManagementModal = document.getElementById('receiptsManagementModal');
        const explanationModal = document.getElementById('explanationModal');
        const replyModal = document.getElementById('replyModal');
        const reminderModal = document.getElementById('reminderModal');
        const ordersTableContainer = document.getElementById('ordersTableContainer');
        const searchFilters = document.getElementById('searchFilters');
        const toggleSearchBtn = document.getElementById('toggleSearchBtn');
        const requesterNameHeader = document.getElementById('requesterNameHeader');

        function generateOrderNumber() {
            return Math.floor(100000 + Math.random() * 900000);
        }

        function initApp() {
            console.log('Initializing app...');
            initTheme();
            setupEventListeners();
            checkAuthState();
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function updateThemeIcon(theme) {
            themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function checkAuthState() {
            console.log('Checking auth state...');
            onAuthStateChanged(auth, async (user) => {
                console.log('Auth state changed:', user ? user.email : 'No user');
                if (user) {
                    currentUser = user;
                    await loadUserData();
                    setupUI();
                    loadOrders();
                } else {
                    console.log('No user found, redirecting to login');
                    window.location.href = 'index.html';
                }
            });
        }

        async function loadUserData() {
            console.log('Loading user data for:', currentUser.email);
            try {
                const userRoles = {
                    'papasnir@gmail.com': {
                        name: 'שניר דואני',
                        role: 'requester',
                        department: 'תכנית בוקר'
                    },
                    'pratimo123@gmail.com': {
                        name: 'לירון אהרן',
                        role: 'requester',
                        department: 'תכנית בוקר'
                    },
                    'emilygolan1@gmail.com': {
                        name: 'אמילי גולן',
                        role: 'approver',
                        department: 'ניהול',
                        approverType: 'emily'
                    },
                    'shulisason@gmail.com': {
                        name: 'שולי ששון',
                        role: 'approver',
                        department: 'ניהול',
                        approverType: 'shuli'
                    },
                    'gadimador@gmail.com': {
                        name: 'ד"ר גדי מדור',
                        role: 'approver',
                        department: 'ניהול',
                        approverType: 'gadi'
                    }
                };

                if (userRoles[currentUser.email]) {
                    userData = userRoles[currentUser.email];
                    userRole = userData.role;
                    
                    console.log('User data loaded:', userData);
                    
                    userName.textContent = userData.name;
                    userAvatar.textContent = userData.name.charAt(0);
                    userRoleElement.textContent = userData.role === 'requester' ? 'מזמין' : 'מאשר הזמנות';

                    try {
                        const userRef = ref(database, `users/${currentUser.uid}`);
                        await set(userRef, {
                            email: currentUser.email,
                            name: userData.name,
                            role: userData.role,
                            department: userData.department,
                            approverType: userData.approverType || null,
                            lastLogin: new Date().toISOString(),
                            photoURL: currentUser.photoURL
                        });
                        console.log('User data saved to database');
                    } catch (saveError) {
                        console.error('Error saving user data:', saveError);
                    }
                } else {
                    console.error('User not authorized:', currentUser.email);
                    alert('המשתמש אינו מורשה לגשת למערכת');
                    await signOut(auth);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('שגיאה בטעינת נתוני משתמש');
            }
        }

        function setupUI() {
            console.log('Setting up UI for role:', userRole);
            if (userRole === 'requester') {
                setupRequesterUI();
            } else if (userRole === 'approver') {
                setupApproverUI();
            }
        }

        function setupRequesterUI() {
            const firstName = userData.name.split(' ')[0];
            welcomeTitle.textContent = `שלום ${firstName}, ברוך הבא למערכת ההזמנות`;
            welcomeSubtitle.textContent = 'כאן תוכל ליצור הזמנות חדשות ולעקוב אחר הסטטוס שלהן';
            tableTitle.textContent = 'ההזמנות שלי';

            // Hide search button for requesters
            toggleSearchBtn.style.display = 'none';

            actionButtons.innerHTML = `
                <div class="action-card" id="newOrderCard">
                    <div class="action-icon">➕</div>
                    <h3 class="action-title">יצירת הזמנה חדשה</h3>
                    <p class="action-description">צור הזמנה חדשה לציוד או שירותים</p>
                </div>
            `;

            setTimeout(() => {
                const newOrderCard = document.getElementById('newOrderCard');
                if (newOrderCard) {
                    newOrderCard.addEventListener('click', openNewOrderModal);
                }
            }, 100);
            
        }

function setupApproverUI() {
    const firstName = userData.name.split(' ')[0];
    welcomeTitle.textContent = `שלום ${firstName}, ברוך הבא למערכת ההזמנות`;
    welcomeSubtitle.textContent = 'כאן תוכל לאשר הזמנות ולנהל את תהליך האישורים';
    tableTitle.textContent = 'הזמנות לאישור';

    // Show requester name column for approvers
    requesterNameHeader.style.display = 'table-cell';

    // Hide email column for approvers
    const emailColumnHeader = document.getElementById('emailColumnHeader');
    if (emailColumnHeader) {
        emailColumnHeader.style.display = 'none';
    }

    actionButtons.innerHTML = `
        <div class="action-card" id="pendingApprovalsCard">
            <div class="action-icon">⏳</div>
            <h3 class="action-title">הזמנות ממתינות לאישור</h3>
            <p class="action-description">הזמנות הממתינות לאישור שלי</p>
        </div>
        <div class="action-card" id="allOrdersCard">
            <div class="action-icon">📊</div>
            <h3 class="action-title">היסטוריית הזמנות</h3>
            <p class="action-description">כל ההזמנות במערכת לפי תאריך</p>
        </div>
    `;

    setTimeout(() => {
        const pendingApprovalsCard = document.getElementById('pendingApprovalsCard');
        const allOrdersCard = document.getElementById('allOrdersCard');
        
        if (pendingApprovalsCard) {
            pendingApprovalsCard.addEventListener('click', showMyPendingApprovals);
        }
        if (allOrdersCard) {
            allOrdersCard.addEventListener('click', showAllOrdersHistory);
        }
    }, 100);
}

        function showMyPendingApprovals() {
            const myApproverType = userData.approverType;
            if (!myApproverType) return;

            const pendingOrders = orders.filter(order => {
                const approvals = order.approvals || {};
                
                if (myApproverType === 'emily') {
                    return approvals.emily === 'pending' || approvals.emily === 'explanation_received';
                } else if (myApproverType === 'shuli') {
                    return (approvals.emily === 'approved' && (approvals.shuli === 'pending' || approvals.shuli === 'explanation_received'));
                } else if (myApproverType === 'gadi') {
                    return order.totalIncludingVat > 9000 && 
                           approvals.emily === 'approved' && 
                           approvals.shuli === 'approved' && 
                           (approvals.gadi === 'pending' || approvals.gadi === 'explanation_received');
                }
                return false;
            });

            tableTitle.textContent = `הזמנות הממתינות לאישור שלי (${pendingOrders.length})`;
            renderOrders(pendingOrders);
            
            ordersTableContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function showAllOrdersHistory() {
            tableTitle.textContent = 'היסטוריית כל ההזמנות';
            filteredOrders = [...orders];
            renderOrders(filteredOrders);
            
            ordersTableContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            themeToggle.addEventListener('click', toggleTheme);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Modal event listeners
            document.getElementById('closeNewOrderModal').addEventListener('click', closeNewOrderModal);
            document.getElementById('closeOrderDetailsModal').addEventListener('click', closeOrderDetailsModal);
            document.getElementById('closeReceiptModal').addEventListener('click', closeReceiptModal);
            document.getElementById('closeReceiptsManagementModal').addEventListener('click', closeReceiptsManagementModal);
            document.getElementById('closeExplanationModal').addEventListener('click', closeExplanationModal);
            document.getElementById('closeReplyModal').addEventListener('click', closeReplyModal);
            document.getElementById('closeReminderModal').addEventListener('click', closeReminderModal);
            document.getElementById('cancelOrderBtn').addEventListener('click', closeNewOrderModal);
            document.getElementById('cancelExplanationBtn').addEventListener('click', closeExplanationModal);
            document.getElementById('cancelReplyBtn').addEventListener('click', closeReplyModal);
            document.getElementById('cancelReminderBtn').addEventListener('click', closeReminderModal);
            
            // Form event listeners
            document.getElementById('newOrderForm').addEventListener('submit', handleOrderSubmit);
            document.getElementById('addItemBtn').addEventListener('click', addOrderItem);
            document.getElementById('printOrderBtn').addEventListener('click', printOrder);
            document.getElementById('sendExplanationBtn').addEventListener('click', sendExplanation);
            document.getElementById('sendReplyBtn').addEventListener('click', sendReply);
            document.getElementById('sendReminderBtn').addEventListener('click', sendReminder);
            
            // Billing type event listeners
            document.querySelectorAll('input[name="billingType"]').forEach(radio => {
                radio.addEventListener('change', handleBillingTypeChange);
            });
            
            document.querySelectorAll('input[name="recurringType"]').forEach(radio => {
                radio.addEventListener('change', handleRecurringTypeChange);
            });

            // Search and filter event listeners
            toggleSearchBtn.addEventListener('click', toggleSearchFilters);
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            
            // Real-time search
            document.getElementById('generalSearch').addEventListener('input', applyFilters);
            document.getElementById('requesterSearch').addEventListener('input', applyFilters);
            
            // Filter event listeners
            filterButtons.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    filterOrders(e.target.dataset.filter);
                }
            });

            // Receipts management
            document.getElementById('newMultipleReceiptFile').addEventListener('change', handleMultipleReceiptFileSelect);
            document.getElementById('addReceiptBtn').addEventListener('click', addNewReceipt);

            // Window click events for modal closing
            window.addEventListener('click', (e) => {
                if (e.target === newOrderModal) closeNewOrderModal();
                if (e.target === orderDetailsModal) closeOrderDetailsModal();
                if (e.target === receiptModal) closeReceiptModal();
                if (e.target === receiptsManagementModal) closeReceiptsManagementModal();
                if (e.target === explanationModal) closeExplanationModal();
                if (e.target === replyModal) closeReplyModal();
                if (e.target === reminderModal) closeReminderModal();
            });
        }

        function handleBillingTypeChange(e) {
            const recurringOptions = document.getElementById('recurringOptions');
            const billingSchedule = document.getElementById('billingSchedule');
            
            if (e.target.value === 'recurring') {
                recurringOptions.classList.add('active');
            } else {
                recurringOptions.classList.remove('active');
                billingSchedule.classList.remove('active');
                // Clear recurring selections
                document.querySelectorAll('input[name="recurringType"]').forEach(radio => {
                    radio.checked = false;
                });
            }
        }

        function handleRecurringTypeChange(e) {
            const billingSchedule = document.getElementById('billingSchedule');
            billingSchedule.classList.add('active');
        }

        function toggleSearchFilters() {
            searchFilters.classList.toggle('active');
            const isActive = searchFilters.classList.contains('active');
            toggleSearchBtn.textContent = isActive ? '🔍 סגור חיפוש' : '🔍 חיפוש מתקדם';
        }

        function applyFilters() {
            if (userRole !== 'approver') return;

            const generalSearch = document.getElementById('generalSearch').value.toLowerCase();
            const requesterSearch = document.getElementById('requesterSearch').value.toLowerCase();
            const departmentFilter = document.getElementById('departmentFilter').value;
            const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
            const maxAmount = parseFloat(document.getElementById('maxAmount').value) || Infinity;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const billingTypeFilter = document.getElementById('billingTypeFilter').value;

            filteredOrders = orders.filter(order => {
                // General search
                if (generalSearch) {
                    const searchText = (order.items || []).map(item => item.productName).join(' ').toLowerCase() + 
                                     order.orderNumber.toString();
                    if (!searchText.includes(generalSearch)) return false;
                }

                // Requester search
                if (requesterSearch && !order.requesterName.toLowerCase().includes(requesterSearch)) {
                    return false;
                }

                // Department filter
                if (departmentFilter && order.department !== departmentFilter) {
                    return false;
                }

                // Amount filters
                if (order.totalIncludingVat < minAmount || order.totalIncludingVat > maxAmount) {
                    return false;
                }

                // Date filters
                if (fromDate && order.orderDate < fromDate) {
                    return false;
                }
                if (toDate && order.orderDate > toDate) {
                    return false;
                }

                // Billing type filter
                if (billingTypeFilter && order.billingType !== billingTypeFilter) {
                    return false;
                }

                return true;
            });

            renderOrders(filteredOrders);
        }

        function clearFilters() {
            document.getElementById('generalSearch').value = '';
            document.getElementById('requesterSearch').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('minAmount').value = '';
            document.getElementById('maxAmount').value = '';
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            document.getElementById('billingTypeFilter').value = '';
            
            filteredOrders = [...orders];
            renderOrders(filteredOrders);
        }

        async function loadOrders() {
            console.log('Loading orders...');
            try {
                const ordersRef = ref(database, 'orders');
                
                onValue(ordersRef, (snapshot) => {
                    orders = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        Object.keys(data).forEach(key => {
                            orders.push({
                                id: key,
                                ...data[key]
                            });
                        });
                    }
                    
                    orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    filteredOrders = [...orders];
                    
                    console.log('Orders loaded:', orders.length);
                    renderOrders();
                });
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function canSendReminder(order) {
            if (userRole !== 'requester') return false;
            
            const approvals = order.approvals || {};
            const emily = approvals.emily || 'pending';
            const shuli = approvals.shuli || 'pending';
            const gadi = order.totalIncludingVat > 9000 ? (approvals.gadi || 'pending') : 'approved';
            
            return emily !== 'approved' || shuli !== 'approved' || gadi !== 'approved';
        }

        function getBillingTypeDisplay(billingType, recurringType) {
            if (billingType === 'onetime') {
                return { text: 'חד פעמי', class: 'billing-onetime' };
            } else if (billingType === 'recurring') {
                if (recurringType === 'monthly') {
                    return { text: 'חודשי', class: 'billing-monthly' };
                } else if (recurringType === 'yearly') {
                    return { text: 'שנתי', class: 'billing-yearly' };
                }
            }
            return { text: 'חד פעמי', class: 'billing-onetime' };
        }

        function renderOrders(ordersToShow = null) {
            const ordersToRender = ordersToShow || (userRole === 'approver' ? filteredOrders : orders);
            const tbody = ordersTableBody;
            
            let userOrders = ordersToRender;
            if (userRole === 'requester') {
                userOrders = ordersToRender.filter(order => order.requesterEmail === currentUser.email);
            }

            if (userOrders.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            tbody.innerHTML = userOrders.map(order => {
                const status = getOrderStatus(order);
                const approvals = getApprovalStatus(order);
                const orderDate = new Date(order.orderDate);
                const billingDisplay = getBillingTypeDisplay(order.billingType, order.recurringType);
                
                let receiptButton = '';
                if (status.canUploadReceipt && userRole === 'requester') {
                    if (order.billingType === 'onetime') {
                        if (order.receiptUploaded) {
                            receiptButton = `<button class="receipt-btn view-receipt-btn" onclick="viewReceipt('${order.id}')">צפה בקבלה</button>`;
                        } else {
                            receiptButton = `<button class="receipt-btn upload-receipt-btn" onclick="uploadReceipt('${order.id}')">העלה קבלה</button>`;
                        }
                    } else {
                        // Recurring billing - show manage receipts button
                        const receiptsCount = order.receipts ? Object.keys(order.receipts).length : 0;
                        receiptButton = `<button class="receipt-btn manage-receipts-btn" onclick="manageReceipts('${order.id}')">נהל קבלות (${receiptsCount})</button>`;
                    }
                } else if (userRole === 'approver') {
                    if (order.billingType === 'onetime') {
                        if (order.receiptUploaded) {
                            receiptButton = `<button class="receipt-btn view-receipt-btn" onclick="viewReceipt('${order.id}')">צפה בקבלה</button>`;
                        } else if (status.class === 'approved') {
                            receiptButton = `<span style="font-size: 0.8rem; color: var(--text-secondary);">עדיין לא הועלתה קבלה</span>`;
                        }
                    } else {
                        // Recurring billing for approvers
                        const receiptsCount = order.receipts ? Object.keys(order.receipts).length : 0;
                        receiptButton = `<button class="receipt-btn view-receipt-btn" onclick="manageReceipts('${order.id}')">צפה בקבלות (${receiptsCount})</button>`;
                    }
                }
                
               const requesterNameCell = userRole === 'approver' ? `<td>${order.requesterName.split(' ')[0]}</td>` : '';
                
   return `
    <tr class="order-row" data-order-id="${order.id}">
        <td>${orderDate.toLocaleDateString('he-IL')}</td>
        ${requesterNameCell}
        <td>${order.orderNumber || generateOrderNumber()}</td>
        <td>${order.department}</td>
        <td><span class="billing-badge ${billingDisplay.class}">${billingDisplay.text}</span></td>
        <td>₪${order.totalIncludingVat.toFixed(2)}</td>
        <td><span class="status-badge status-${status.class}">${status.text}</span></td>
        ${userRole === 'requester' ? `
        <td>
            ${canSendReminder(order) ? 
                `<button class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.3rem 0.8rem;" onclick="openReminderModal('${order.id}')">🔔</button>` : 
                '<span style="color: var(--text-secondary); font-size: 0.8rem;">-</span>'
            }
        </td>` : ''}
        <td>
            <div class="approval-status">
                ${approvals.map(approval => `
                    <div class="approval-item">
                        <div class="approval-icon approval-${approval.status}"></div>
                        <span>${approval.name} - ${approval.statusText}</span>
                    </div>
                `).join('')}
            </div>
        </td>
        <td>
            <button class="expand-btn" onclick="openOrderDetails('${order.id}')">פרטים</button>
            ${receiptButton}
        </td>
    </tr>
`;
            }).join('');
        }

        function getOrderStatus(order) {
            const approvals = order.approvals || {};
            const emily = approvals.emily || 'pending';
            const shuli = approvals.shuli || 'pending';
            const gadi = order.totalIncludingVat > 9000 ? (approvals.gadi || 'pending') : 'approved';

            // Check for explanation needed status
            if (emily === 'explanation_needed' || shuli === 'explanation_needed' || gadi === 'explanation_needed') {
                return { class: 'explanation-needed', text: 'ממתין לנימוק', canUploadReceipt: false };
            }

            if (emily === 'rejected' || shuli === 'rejected' || gadi === 'rejected') {
                return { class: 'rejected', text: 'נדחה', canUploadReceipt: false };
            }

            if (emily === 'approved' && shuli === 'approved' && gadi === 'approved') {
                return { class: 'approved', text: 'מאושר', canUploadReceipt: true };
            }

            if (emily === 'approved' || shuli === 'approved') {
                return { class: 'partial', text: 'אושר חלקית', canUploadReceipt: false };
            }

            return { class: 'pending', text: 'בהמתנה', canUploadReceipt: false };
        }

        function getApprovalStatus(order) {
            const approvals = order.approvals || {};
            const result = [
                {
                    name: 'אמילי',
                    key: 'emily',
                    status: approvals.emily || 'pending',
                    statusText: getStatusText(approvals.emily || 'pending')
                },
                {
                    name: 'שולי', 
                    key: 'shuli',
                    status: approvals.shuli || 'pending',
                    statusText: getStatusText(approvals.shuli || 'pending')
                }
            ];

            if (order.totalIncludingVat > 9000) {
                result.push({
                    name: 'גדי',
                    key: 'gadi',
                    status: approvals.gadi || 'pending',
                    statusText: getStatusText(approvals.gadi || 'pending')
                });
            }

            return result;
        }

        function getStatusText(status) {
            switch (status) {
                case 'approved': return 'אושר';
                case 'rejected': return 'נדחה';
                case 'explanation_needed': return 'ממתין לנימוק';
                case 'explanation_received': return 'בבדיקה חוזרת';
                default: return 'בהמתנה';
            }
        }

        function filterOrders(filter) {
            let filtered = userRole === 'approver' ? filteredOrders : orders;
            
            if (filter !== 'all') {
                filtered = filtered.filter(order => {
                    const status = getOrderStatus(order);
                    return status.class === filter;
                });
            }
            
            renderOrders(filtered);
        }

        // Modal functions
        function closeReceiptModal() {
            receiptModal.classList.remove('active');
        }

        function closeReceiptsManagementModal() {
            receiptsManagementModal.classList.remove('active');
            currentOrderId = null;
        }

        function closeExplanationModal() {
            explanationModal.classList.remove('active');
            document.getElementById('explanationText').value = '';
            currentOrderId = null;
            currentApproverKey = null;
        }

        function closeReplyModal() {
            replyModal.classList.remove('active');
            document.getElementById('replyText').value = '';
            currentOrderId = null;
            currentApproverKey = null;
        }

        function closeReminderModal() {
            reminderModal.classList.remove('active');
            currentReminderOrderId = null;
        }

        function openNewOrderModal() {
            console.log('Opening new order modal...');
            newOrderModal.classList.add('active');
            
            // רק אם השדות ריקים - מלא אותם
            if (!document.getElementById('requesterName').value) {
                document.getElementById('requesterName').value = userData.name;
            }
            if (!document.getElementById('orderDate').value) {
                document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            }
            
            // עדכן את הסיכום הכספי (במקרה שיש נתונים קיימים)
            updateOrderSummary();
        }

        function closeNewOrderModal() {
            newOrderModal.classList.remove('active');
        }

        function closeOrderDetailsModal() {
            orderDetailsModal.classList.remove('active');
        }

        function addOrderItem() {
            itemCounter++;
            const orderItems = document.getElementById('orderItems');
            
            const newItem = document.createElement('div');
            newItem.className = 'order-item';
            newItem.dataset.item = itemCounter;
            newItem.innerHTML = `
                <hr style="margin: 2rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4>פריט #${itemCounter + 1}</h4>
                    <button type="button" class="btn btn-danger" style="font-size: 0.8rem; padding: 0.3rem 0.8rem;" onclick="removeOrderItem(${itemCounter})">הסר פריט</button>
                </div>
                <div class="form-group">
                    <label class="form-label">שם המוצר ותיאור</label>
                    <input type="text" class="form-input" name="productName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">מטרה - תיאור הצורך</label>
                    <textarea class="form-textarea" name="purpose" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">כמות קיימת במלאי</label>
                    <input type="number" class="form-input" name="stockQuantity" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">שם הספק</label>
                    <input type="text" class="form-input" name="supplier" required>
                </div>
                <div class="form-group">
                    <label class="form-label">עלות בש"ח כולל מע"מ</label>
                    <input type="number" class="form-input cost-input" name="cost" step="0.01" min="0" required>
                </div>
            `;
            
            orderItems.appendChild(newItem);
            
            const costInput = newItem.querySelector('.cost-input');
            costInput.addEventListener('input', updateOrderSummary);
        }

        function removeOrderItem(itemId) {
            const item = document.querySelector(`[data-item="${itemId}"]`);
            if (item) {
                item.remove();
                updateOrderSummary();
            }
        }

        function updateOrderSummary() {
            const costInputs = document.querySelectorAll('.cost-input');
            
            let totalIncludingVat = 0;
            let totalExcludingVat = 0;
            
            costInputs.forEach((input) => {
                const cost = parseFloat(input.value) || 0;
                totalIncludingVat += cost;
                totalExcludingVat += cost / 1.18;
            });
            
            document.getElementById('totalExcludingVat').textContent = `₪${totalExcludingVat.toFixed(2)}`;
            document.getElementById('totalIncludingVat').textContent = `₪${totalIncludingVat.toFixed(2)}`;
        }

        async function handleOrderSubmit(e) {
            e.preventDefault();
            console.log('Submitting order...');
            
            const submitBtn = document.getElementById('submitOrderBtn');
            const btnText = submitBtn.querySelector('span');
            const loading = submitBtn.querySelector('.loading');
            
            btnText.style.display = 'none';
            loading.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                const orderItemsElements = document.querySelectorAll('.order-item');
                
                const items = [];
                orderItemsElements.forEach((item, index) => {
                    const inputs = item.querySelectorAll('input, textarea, select');
                    const itemData = {};
                    
                    inputs.forEach(input => {
                        if (input.name) {
                            itemData[input.name] = input.value;
                        }
                    });
                    
                    if (itemData.productName) {
                        items.push(itemData);
                    }
                });
                
                if (items.length === 0) {
                    alert('אנא הוסף לפחות פריט אחד להזמנה');
                    return;
                }
                
                let totalExcludingVat = 0;
                let totalIncludingVat = 0;
                
                items.forEach(item => {
                    const cost = parseFloat(item.cost) || 0;
                    totalIncludingVat += cost;
                    totalExcludingVat += cost / 1.18;
                });

                // Get billing information
                const billingType = document.querySelector('input[name="billingType"]:checked').value;
                const recurringType = document.querySelector('input[name="recurringType"]:checked')?.value;
                const firstBillingDate = document.getElementById('firstBillingDate').value;
                const billingCount = document.getElementById('billingCount').value;
                
                const order = {
                    requesterEmail: currentUser.email,
                    requesterName: userData.name,
                    orderDate: document.getElementById('orderDate').value,
                    department: document.getElementById('department').value,
                    orderNotes: document.getElementById('orderNotes').value,
                    items: items,
                    totalExcludingVat: totalExcludingVat,
                    totalIncludingVat: totalIncludingVat,
                    status: 'pending',
                    billingType: billingType,
                    recurringType: recurringType || null,
                    firstBillingDate: firstBillingDate || null,
                    billingCount: billingCount ? parseInt(billingCount) : null,
                    approvals: {
                        emily: 'pending',
                        shuli: 'pending'
                    },
                    createdAt: new Date().toISOString(),
                    orderNumber: generateOrderNumber(),
                    receiptUploaded: false,
                    receipts: {}
                };
                
                if (totalIncludingVat > 9000) {
                    order.approvals.gadi = 'pending';
                }
                
                console.log('Order to save:', order);
                
                const ordersRef = ref(database, 'orders');
                await push(ordersRef, order);
                
                // בדיקה אם לשלוח מייל
                const sendEmail = document.getElementById('sendEmailNotification').checked;
                if (sendEmail) {
                    try {
                        await sendNewOrderEmails(order);
                        console.log('Email notifications sent successfully');
                    } catch (error) {
                        console.error('Error sending email notifications:', error);
                        // לא לעצור את התהליך אם המייל נכשל
                    }
                }
                
                alert('ההזמנה נשלחה בהצלחה לאישור!');
                // נקה את הטופס רק אחרי שליחה מוצלחת
                const form = document.getElementById('newOrderForm');
                form.reset();
                itemCounter = 0;
                const orderItems = document.getElementById('orderItems');
                const extraItems = orderItems.querySelectorAll('.order-item[data-item]:not([data-item="0"])');
                extraItems.forEach(item => item.remove());

                // Reset billing options
                document.getElementById('recurringOptions').classList.remove('active');
                document.getElementById('billingSchedule').classList.remove('active');

                closeNewOrderModal();
                
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('אירעה שגיאה בשליחת ההזמנה. אנא נסה שוב.');
            } finally {
                btnText.style.display = 'block';
                loading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // Receipt management functions
        function handleMultipleReceiptFileSelect(e) {
            const addBtn = document.getElementById('addReceiptBtn');
            if (e.target.files.length > 0) {
                addBtn.style.display = 'inline-flex';
            } else {
                addBtn.style.display = 'none';
            }
        }

        async function addNewReceipt() {
            const fileInput = document.getElementById('newMultipleReceiptFile');
            const receiptDate = document.getElementById('receiptDate').value;
            const receiptNotes = document.getElementById('receiptNotes').value;
            
            if (!fileInput.files[0]) {
                alert('אנא בחר קובץ קבלה');
                return;
            }
            
            if (!receiptDate) {
                alert('אנא בחר תאריך חיוב');
                return;
            }
            
            try {
                const addBtn = document.getElementById('addReceiptBtn');
                addBtn.disabled = true;
                addBtn.innerHTML = '<div class="loading"></div> מעלה...';
                
                const file = fileInput.files[0];
                const receiptId = Date.now().toString();
                
                // Upload file
                const timestamp = new Date().getTime();
                const fileExtension = file.name.split('.').pop();
                const fileName = `receipts/${currentOrderId}_${receiptId}.${fileExtension}`;
                const receiptRef = storageRef(storage, fileName);
                
                const snapshot = await uploadBytes(receiptRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                // Save receipt data
                const orderReceiptRef = ref(database, `orders/${currentOrderId}/receipts/${receiptId}`);
                await set(orderReceiptRef, {
                    receiptDate: receiptDate,
                    receiptNotes: receiptNotes,
                    fileName: file.name,
                    downloadURL: downloadURL,
                    uploadDate: new Date().toISOString()
                });
                
                alert('הקבלה נוספה בהצלחה!');
                
                // Reset form
                fileInput.value = '';document.getElementById('receiptDate').value = '';
                document.getElementById('receiptNotes').value = '';
                addBtn.style.display = 'none';
                
                // Refresh receipts list
                loadReceiptsList(currentOrderId);
                
            } catch (error) {
                console.error('Error adding receipt:', error);
                alert('שגיאה בהעלאת הקבלה: ' + error.message);
            } finally {
                const addBtn = document.getElementById('addReceiptBtn');
                addBtn.disabled = false;
                addBtn.innerHTML = '➕ הוסף קבלה';
            }
        }

        async function loadReceiptsList(orderId) {
            try {
                const orderRef = ref(database, `orders/${orderId}`);
                const snapshot = await get(orderRef);
                
                if (snapshot.exists()) {
                    const order = snapshot.val();
                    const receipts = order.receipts || {};
                    const existingReceipts = document.getElementById('existingReceipts');
                    
                    if (Object.keys(receipts).length === 0) {
                        existingReceipts.innerHTML = '<p style="color: var(--text-secondary);">אין קבלות</p>';
                        return;
                    }
                    
                    existingReceipts.innerHTML = Object.entries(receipts).map(([receiptId, receipt]) => `
                        <div class="receipt-item">
                            <div class="receipt-info">
                                <strong>${formatDate(receipt.receiptDate)}</strong>
                                <p style="margin: 0.2rem 0; color: var(--text-secondary);">${receipt.fileName}</p>
                                ${receipt.receiptNotes ? `<p style="margin: 0.2rem 0; font-size: 0.9rem;">${receipt.receiptNotes}</p>` : ''}
                            </div>
                            <div class="receipt-actions">
                                <button class="btn btn-secondary btn-small" onclick="viewSingleReceipt('${receipt.downloadURL}', '${receipt.fileName}')">
                                    👁️ צפה
                                </button>
                                ${userRole === 'requester' ? `
                                <button class="btn btn-danger btn-small" onclick="deleteReceipt('${orderId}', '${receiptId}')">
                                    🗑️ מחק
                                </button>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading receipts list:', error);
            }
        }

        window.manageReceipts = async function(orderId) {
            currentOrderId = orderId;
            const order = orders.find(o => o.id === orderId);
            
            if (!order) return;
            
            if (userRole === 'requester' && order.billingType === 'recurring') {
                // Show management modal for requesters with recurring billing
                receiptsManagementModal.classList.add('active');
                await loadReceiptsList(orderId);
            } else {
                // Show view-only for approvers or single receipts
                receiptsManagementModal.classList.add('active');
                await loadReceiptsList(orderId);
                
                // Hide add receipt functionality for approvers
                if (userRole === 'approver') {
                    document.querySelector('.file-upload').style.display = 'none';
                }
            }
        };

        window.viewSingleReceipt = function(receiptURL, fileName) {
            window.open(receiptURL, '_blank');
        };

        window.deleteReceipt = async function(orderId, receiptId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק קבלה זו?')) return;
            
            try {
                const receiptRef = ref(database, `orders/${orderId}/receipts/${receiptId}`);
                await set(receiptRef, null);
                
                alert('הקבלה נמחקה בהצלחה');
                await loadReceiptsList(orderId);
                
            } catch (error) {
                console.error('Error deleting receipt:', error);
                alert('שגיאה במחיקת הקבלה');
            }
        };

        async function sendExplanation() {
            const explanationText = document.getElementById('explanationText').value.trim();
            
            if (!explanationText) {
                alert('אנא כתוב הסבר למזמין');
                return;
            }
            
            try {
                const orderRef = ref(database, `orders/${currentOrderId}/approvals/${currentApproverKey}`);
                await set(orderRef, 'explanation_needed');
                
                const explanationRef = ref(database, `orders/${currentOrderId}/explanations/${currentApproverKey}`);
                await set(explanationRef, {
                    text: explanationText,
                    timestamp: new Date().toISOString(),
                    from: userData.name
                });
                
                alert('ההסבר נשלח למזמין בהצלחה!');
                closeExplanationModal();
                closeOrderDetailsModal();
                
            } catch (error) {
                console.error('Error sending explanation:', error);
                alert('שגיאה בשליחת ההסבר');
            }
        }

        async function sendReply() {
            const replyText = document.getElementById('replyText').value.trim();
            
            if (!replyText) {
                alert('אנא כתוב תגובה למאשר');
                return;
            }
            
            try {
                const orderRef = ref(database, `orders/${currentOrderId}/approvals/${currentApproverKey}`);
                await set(orderRef, 'explanation_received');
                
                const replyRef = ref(database, `orders/${currentOrderId}/replies/${currentApproverKey}`);
                await set(replyRef, {
                    text: replyText,
                    timestamp: new Date().toISOString(),
                    from: userData.name
                });
                
                alert('התגובה נשלחה למאשר בהצלחה!');
                closeReplyModal();
                closeOrderDetailsModal();
                
            } catch (error) {
                console.error('Error sending reply:', error);
                alert('שגיאה בשליחת התגובה');
            }
        }

        // פונקציות תזכורת מייל
        window.openReminderModal = function(orderId) {
            currentReminderOrderId = orderId;
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const approvals = order.approvals || {};
            const approversList = document.getElementById('approversList');
            
            let pendingApprovers = [];
            
            if ((approvals.emily || 'pending') !== 'approved') {
                pendingApprovers.push({key: 'emily', name: 'אמילי גולן', email: approverEmails.emily});
            }
            if ((approvals.shuli || 'pending') !== 'approved') {
                pendingApprovers.push({key: 'shuli', name: 'שולי ששון', email: approverEmails.shuli});
            }
            if (order.totalIncludingVat > 9000 && (approvals.gadi || 'pending') !== 'approved') {
                pendingApprovers.push({key: 'gadi', name: 'ד"ר גדי מדור', email: approverEmails.gadi});
            }
            
            if (pendingApprovers.length === 0) {
                alert('כל המאשרים כבר אישרו את ההזמנה');
                return;
            }
            
            let checkboxes = pendingApprovers.map(approver => `
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0; cursor: pointer;">
                    <input type="checkbox" value="${approver.key}" class="reminder-checkbox">
                    <span>${approver.name}</span>
                </label>
            `).join('');
            
            if (pendingApprovers.length > 1) {
                checkboxes += `
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 1rem 0; cursor: pointer; font-weight: bold;">
                        <input type="checkbox" id="selectAllApprovers">
                        <span>בחר הכל</span>
                    </label>
                `;
            }
            
            approversList.innerHTML = checkboxes;
            
            const selectAll = document.getElementById('selectAllApprovers');
            if (selectAll) {
                selectAll.addEventListener('change', (e) => {
                    const checkboxes = document.querySelectorAll('.reminder-checkbox');
                    checkboxes.forEach(cb => cb.checked = e.target.checked);
                });
            }
            
            reminderModal.classList.add('active');
        };

        async function sendReminder() {
            const selectedApprovers = Array.from(document.querySelectorAll('.reminder-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedApprovers.length === 0) {
                alert('אנא בחר לפחות מאשר אחד');
                return;
            }
            
            const order = orders.find(o => o.id === currentReminderOrderId);
            if (!order) return;
            
            try {
                const sendBtn = document.getElementById('sendReminderBtn');
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<div class="loading"></div> שולח...';
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const approverKey of selectedApprovers) {
                    const approverEmail = approverEmails[approverKey];
                    const approverName = getApproverName(approverKey);
                    
                    try {
                        await sendEmailReminder(approverEmail, approverName, order);
                        successCount++;
                        console.log(`תזכורת נשלחה ל-${approverName}`);
                    } catch (error) {
                        errorCount++;
                        console.error(`שגיאה עבור ${approverName}:`, error);
                    }
                }
                
                if (successCount > 0) {
                    alert(`תזכורות נשלחו בהצלחה ל-${successCount} מאשרים!`);
                }
                if (errorCount > 0) {
                    alert(`שגיאה בשליחה ל-${errorCount} מאשרים`);
                }
                
                if (successCount > 0) {
                    closeReminderModal();
                }
                
            } catch (error) {
                console.error('Error sending reminders:', error);
                alert('שגיאה בשליחת התזכורות');
            } finally {
                const sendBtn = document.getElementById('sendReminderBtn');
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'שלח מייל';
            }
        }

        function getApproverName(approverKey) {
            const names = {
                'emily': 'אמילי',
                'shuli': 'שולי', 
                'gadi': 'ד"ר גדי'
            };
            return names[approverKey] || approverKey;
        }

        async function sendEmailReminder(email, approverName, order) {
            const templateParams = {
                to_email: email,
                to_name: approverName,
                from_name: 'מערכת ההזמנות',
                subject: 'תזכורת: הזמנה ממתינה לאישור במערכת ההזמנות',
                approver_name: approverName,
                requester_name: order.requesterName,
                order_number: order.orderNumber,
                total_amount: order.totalIncludingVat.toFixed(2),
                order_date: formatDate(order.orderDate),
                system_link: 'https://snirsnir.github.io/orders/index.html'
            };
            
            console.log('Sending reminder email to:', email, 'with params:', templateParams);
            
            return await emailjs.send(
                'service_lgb24x4',
                'template_069cokp',
                templateParams
            );
        }

        async function sendNewOrderEmails(order) {
            const approversToNotify = [];
            
            // אמילי תמיד מקבלת
            approversToNotify.push({
                email: approverEmails.emily,
                name: 'אמילי'
            });
            
            // שולי תמיד מקבלת (אחרי אמילי)
            approversToNotify.push({
                email: approverEmails.shuli,
                name: 'שולי'
            });
            
            // גדי מקבל רק אם הסכום מעל 9000
            if (order.totalIncludingVat > 9000) {
                approversToNotify.push({
                    email: approverEmails.gadi,
                    name: 'ד"ר גדי'
                });
            }
            
            for (const approver of approversToNotify) {
                await sendNewOrderEmail(approver.email, approver.name, order);
            }
        }

        async function sendNewOrderEmail(email, approverName, order) {
            const firstItem = order.items[0];
            const productName = firstItem ? firstItem.productName : 'מוצרים שונים';
            
            const templateParams = {
                to_email: email,
                to_name: approverName,
                from_name: 'מערכת ההזמנות',
                subject: 'הזמנה חדשה ממערכת ההזמנות',
                approver_name: approverName,
                requester_name: order.requesterName,
                product_name: productName,
                order_number: order.orderNumber,
                total_amount: order.totalIncludingVat.toFixed(2),
                order_date: formatDate(order.orderDate),
                system_link: 'https://snirsnir.github.io/orders/index.html'
            };
            
            console.log('Sending new order email to:', email, 'with params:', templateParams);
            
            return await emailjs.send(
                'service_lgb24x4',
                'template_069cokp',
                templateParams
            );
        }

        function printOrder() {
            const order = window.currentOrderForPrint;
            if (!order) {
                alert('אין הזמנה להדפסה');
                return;
            }

            const printContent = document.getElementById('printOrderContent');
            const needsGadi = order.totalIncludingVat > 9000;
            const approvals = order.approvals || {};
            const billingDisplay = getBillingTypeDisplay(order.billingType, order.recurringType);
            
            function getSignatureText(approverKey) {
                const status = approvals[approverKey];
                if (status === 'approved') {
                    return 'נחתם דיגיטלית';
                } else if (status === 'rejected') {
                    return 'נדחה';
                }
                return '';
            }

            printContent.innerHTML = `
                <div class="print-section" style="text-align: center; margin-bottom: 15px;">
                    <h2 style="margin: 0; padding: 0;">טופס הזמנת עבודה או ציוד</h2>
                </div>
                
                <div class="print-section">
                    <h3 style="text-align: center; margin: 8px 0; background-color: #f0f0f0; padding: 3px;">פרטי המזמין</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 12px;">
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px; width: 25%; font-weight: bold;">שם המזמין</td>
                            <td style="border: 1px solid #000; padding: 4px; width: 25%;">${order.requesterName.split(' ')[0]}</td>
                            <td style="border: 1px solid #000; padding: 4px; width: 25%; font-weight: bold;">תאריך</td>
                            <td style="border: 1px solid #000; padding: 4px; width: 25%;">${formatDate(order.orderDate)}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">סעיף תקציבי</td>
                            <td style="border: 1px solid #000; padding: 4px;" colspan="3">${order.department}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">סוג חיוב</td>
                            <td style="border: 1px solid #000; padding: 4px;" colspan="3">${billingDisplay.text}</td>
                        </tr>
                        ${order.orderNotes ? `
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">הערות</td>
                            <td style="border: 1px solid #000; padding: 4px;" colspan="3">${order.orderNotes}</td>
                        </tr>` : ''}
                    </table>
                </div>

                <div class="print-section">
                    <h3 style="text-align: center; margin: 8px 0; background-color: #f0f0f0; padding: 3px;">תיאור המוצר</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 12px;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-size: 9px;">שם המוצר תיאור המוצר או העבודה</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-size: 9px;">מטרה- תיאור הצורך</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-size: 9px;">כמות קיימת במלאי</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-size: 9px;">הערות</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-size: 9px;">שם הספק</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-size: 9px;">עלות בש"ח כולל מע"מ</th>
                        </tr>
                        ${order.items.map(item => `
                            <tr>
                                <td style="border: 1px solid #000; padding: 3px; font-size: 9px;">${item.productName}</td>
                                <td style="border: 1px solid #000; padding: 3px; font-size: 9px;">${item.purpose}</td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px;">${item.stockQuantity || 0}</td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px;">-</td>
                                <td style="border: 1px solid #000; padding: 3px; font-size: 9px;">${item.supplier}</td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px;">₪${parseFloat(item.cost).toFixed(2)} (כולל מע"מ)</td>
                            </tr>
                        `).join('')}
                    </table>
                    
                    <div style="text-align: left; margin: 8px 0; font-weight: bold; font-size: 11px;">
                        <p style="margin: 2px 0;">סה"כ תשלום: ₪${order.totalIncludingVat.toFixed(2)}</p>
                        <p style="margin: 2px 0;">סוג חיוב: ${billingDisplay.text}</p>
                    </div>
                </div>

                <div class="print-section">
                    <p style="margin: 10px 0; font-size: 10px;"><strong>במידה וההזמנה כוללת כמות גדולה של פריטים ניתן לצרף את דף ההזמנה</strong></p>
                    
                    <h3 style="text-align: center; margin: 8px 0; background-color: #f0f0f0; padding: 3px;">אישור ההזמנה (חתימות)</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; width: 20%;">שם המאשר</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; width: 25%;">הערות</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; width: 15%;">תאריך</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; width: 20%;">הגבלת הזמנה</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; width: 20%;">חתימה</th>
                        </tr>
                        ${needsGadi ? `
                        <tr>
                            <td style="border: 1px solid #000; padding: 6px; height: 25px;">ד"ר גדי מדור</td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px; text-align: center;"><span class="signature-approved">${getSignatureText('gadi')}</span></td>
                        </tr>` : ''}
                        <tr>
                            <td style="border: 1px solid #000; padding: 6px; height: 25px;">אמילי גולן</td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px; text-align: center;"><span class="signature-approved">${getSignatureText('emily')}</span></td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 6px; height: 25px;">שולי ששון</td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px;"></td>
                            <td style="border: 1px solid #000; padding: 6px; text-align: center;"><span class="signature-approved">${getSignatureText('shuli')}</span></td>
                        </tr>
                    </table>
                </div>
            `;

            setTimeout(() => {
                window.print();
            }, 200);
        }

        // Global functions for onclick events
        window.openOrderDetails = async function(orderId) {
            try {
                const order = orders.find(o => o.id === orderId);
                if (!order) return;
                
                const approvals = getApprovalStatus(order);
                const status = getOrderStatus(order);
                const billingDisplay = getBillingTypeDisplay(order.billingType, order.recurringType);
                
                let orderNotesSection = '';
                if (order.orderNotes) {
                    orderNotesSection = `
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <h4>הערות להזמנה</h4>
                            <p style="margin: 0.5rem 0;"><strong>${order.orderNotes}</strong></p>
                        </div>
                    `;
                }

                let billingSection = '';
                if (order.billingType !== 'onetime') {
                    billingSection = `
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <h4>פרטי חיוב</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div><strong>סוג חיוב:</strong> ${billingDisplay.text}</div>
                                ${order.firstBillingDate ? `<div><strong>תאריך חיוב ראשון:</strong> ${formatDate(order.firstBillingDate)}</div>` : ''}
                                ${order.billingCount ? `<div><strong>מספר חיובים:</strong> ${order.billingCount}</div>` : '<div><strong>חיוב:</strong> רציף</div>'}
                            </div>
                        </div>
                    `;
                }
                
                let explanationsSection = '';
                if (order.explanations || order.replies) {
                    explanationsSection = '<div style="margin: 2rem 0;"><h4>תקשורת עם מאשרים</h4>';
                    
                    approvals.forEach(approval => {
                        const explanation = order.explanations && order.explanations[approval.key];
                        const reply = order.replies && order.replies[approval.key];
                        
                        if (explanation || reply) {
                            explanationsSection += `<div style="margin: 1rem 0; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">`;
                            explanationsSection += `<h5>${approval.name}</h5>`;
                            
                            if (explanation) {
                                explanationsSection += `
                                    <div class="explanation-section">
                                        <div class="explanation-text">הסבר דרוש:</div>
                                        <p><strong>${explanation.text}</strong></p>
                                        <small>נשלח ב: ${formatDate(explanation.timestamp)}</small>
                                    </div>
                                `;
                            }
                            
                            if (reply) {
                                explanationsSection += `
                                    <div class="reply-section">
                                        <div class="reply-text">תגובת המזמין:</div>
                                        <p><strong>${reply.text}</strong></p>
                                        <small>נשלח ב: ${formatDate(reply.timestamp)}</small>
                                    </div>
                                `;
                            }
                            
                            explanationsSection += '</div>';
                        }
                    });
                    explanationsSection += '</div>';
                }
                
                document.getElementById('orderDetailsContent').innerHTML = `
                    <div style="margin-bottom: 2rem;">
                        <h3>פרטי הזמנה #${order.orderNumber || generateOrderNumber()}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                            <div><strong>מזמין:</strong> ${order.requesterName.split(' ')[0]}</div>
                            <div><strong>תאריך יצירה:</strong> ${formatDate(order.createdAt)}</div>
                            <div><strong>תאריך:</strong> ${formatDate(order.orderDate)}</div>
                            <div><strong>סעיף תקציבי:</strong> ${order.department}</div>
                            <div><strong>סוג חיוב:</strong> <span class="billing-badge ${billingDisplay.class}">${billingDisplay.text}</span></div>
                            <div><strong>סטטוס:</strong> <span class="status-badge status-${status.class}">${status.text}</span></div>
                        </div>
                    </div>
                    
                    ${orderNotesSection}
                    ${billingSection}
                    
                    <div style="margin-bottom: 2rem;">
                        <h4>סטטוס אישורים</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin: 1rem 0;">
                            ${approvals.map(approval => {
                                const explanation = order.explanations && order.explanations[approval.key];
                                const reply = order.replies && order.replies[approval.key];
                                
                                let actionButtons = '';
                                if (userRole === 'approver' && isUserApprover(approval.name)) {
                                    if (approval.status === 'pending') {
                                        actionButtons = `
                                            <div style="margin-right: auto;">
                                                <button class="btn btn-success" style="font-size: 0.8rem; padding: 0.3rem 0.8rem; margin-left: 0.5rem;" onclick="approveOrder('${orderId}', '${approval.key}')">אשר</button>
                                                <button class="btn btn-warning" style="font-size: 0.8rem; padding: 0.3rem 0.8rem; margin-left: 0.5rem;" onclick="requestExplanation('${orderId}', '${approval.key}')">דרוש הסבר</button>
                                                <button class="btn btn-danger" style="font-size: 0.8rem; padding: 0.3rem 0.8rem;" onclick="rejectOrder('${orderId}', '${approval.key}')">דחה</button>
                                            </div>
                                        `;
                                    } else if (approval.status === 'explanation_received') {
                                        actionButtons = `
                                            <div style="margin-right: auto;">
                                                <button class="btn btn-success" style="font-size: 0.8rem; padding: 0.3rem 0.8rem; margin-left: 0.5rem;" onclick="approveOrder('${orderId}', '${approval.key}')">אשר</button>
                                                <button class="btn btn-danger" style="font-size: 0.8rem; padding: 0.3rem 0.8rem;" onclick="rejectOrder('${orderId}', '${approval.key}')">דחה</button>
                                            </div>
                                        `;
                                    }
                                } else if (userRole === 'requester' && approval.status === 'explanation_needed') {
                                    actionButtons = `
                                        <div style="margin-right: auto;">
                                            <button class="btn btn-primary" style="font-size: 0.8rem; padding: 0.3rem 0.8rem;" onclick="replyToExplanation('${orderId}', '${approval.key}')">הגב</button>
                                        </div>
                                    `;
                                }
                                
                                let explanationText = '';
                                if (explanation) {
                                    explanationText = `<br><small style="font-weight: bold; color: var(--explanation-needed);">${explanation.text}</small>`;
                                }
                                
                                return `
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div class="approval-icon approval-${approval.status}" style="width: 16px; height: 16px;"></div>
                                        <span><strong>${approval.name}:</strong> ${approval.statusText}${explanationText}</span>
                                        ${actionButtons}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    ${explanationsSection}
                    
                    <div style="margin-bottom: 2rem;">
                        <h4>פריטי ההזמנה</h4>
                        ${order.items.map((item, index) => `
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h5>פריט #${index + 1}</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin: 0.5rem 0;">
                                    <div><strong>מוצר:</strong> ${item.productName}</div>
                                    <div><strong>ספק:</strong> ${item.supplier}</div>
                                    <div><strong>עלות:</strong> ₪${parseFloat(item.cost).toFixed(2)} (כולל מע"מ)</div>
                                </div>
                                <div style="margin: 0.5rem 0;">
                                    <strong>מטרה:</strong> ${item.purpose}
                                </div>
                                <div>
                                    <strong>כמות במלאי:</strong> ${item.stockQuantity || 0}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px;">
                        <h4>סיכום כספי</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                            <div><strong>סה"כ לא כולל מע"מ:</strong> ₪${order.totalExcludingVat.toFixed(2)}</div>
                            <div><strong>סה"כ כולל מע"מ:</strong> ₪${order.totalIncludingVat.toFixed(2)}</div>
                            <div><strong>סוג חיוב:</strong> <span class="billing-badge ${billingDisplay.class}">${billingDisplay.text}</span></div>
                        </div>
                    </div>
                `;
                
                window.currentOrderForPrint = order;
                orderDetailsModal.classList.add('active');
                
            } catch (error) {
                console.error('Error loading order details:', error);
                alert('שגיאה בטעינת פרטי ההזמנה');
            }
        };

        window.requestExplanation = function(orderId, approverKey) {
            currentOrderId = orderId;
            currentApproverKey = approverKey;
            explanationModal.classList.add('active');
        };

        window.replyToExplanation = function(orderId, approverKey) {
            currentOrderId = orderId;
            currentApproverKey = approverKey;
            replyModal.classList.add('active');
        };

        window.approveOrder = async function(orderId, approver) {
            if (confirm(`האם אתה בטוח שברצונך לאשר הזמנה זו?`)) {
                try {
                    const orderRef = ref(database, `orders/${orderId}/approvals/${approver}`);
                    await set(orderRef, 'approved');
                    alert('ההזמנה אושרה בהצלחה!');
                    closeOrderDetailsModal();
                } catch (error) {
                    console.error('Error approving order:', error);
                    alert('שגיאה באישור ההזמנה');
                }
            }
        };

        window.rejectOrder = async function(orderId, approver) {
            if (confirm(`האם אתה בטוח שברצונך לדחות הזמנה זו?`)) {
                try {
                    const orderRef = ref(database, `orders/${orderId}/approvals/${approver}`);
                    await set(orderRef, 'rejected');
                    alert('ההזמנה נדחתה');
                    closeOrderDetailsModal();
                } catch (error) {
                    console.error('Error rejecting order:', error);
                    alert('שגיאה בדחיית ההזמנה');
                }
            }
        };

        // Receipt and file functions
        async function uploadReceiptFile(orderId, file) {
            try {
                console.log('Uploading receipt for order:', orderId);
                
                const timestamp = new Date().getTime();
                const fileExtension = file.name.split('.').pop();
                const fileName = `receipts/${orderId}_${timestamp}.${fileExtension}`;
                const receiptRef = storageRef(storage, fileName);
                
                const snapshot = await uploadBytes(receiptRef, file);
                console.log('File uploaded successfully');
                
                const downloadURL = await getDownloadURL(snapshot.ref);
                console.log('Download URL:', downloadURL);
                
                const orderRef = ref(database, `orders/${orderId}`);
                await update(orderRef, {
                    receiptUploaded: true,
                    receiptURL: downloadURL,
                    receiptFileName: file.name,
                    receiptUploadDate: new Date().toISOString()
                });
                
                console.log('Order updated with receipt info');
                alert('הקבלה הועלתה בהצלחה!');
                
                return downloadURL;
            } catch (error) {
                console.error('Error uploading receipt:', error);
                alert('שגיאה בהעלאת הקבלה: ' + error.message);
                throw error;
            }
        }

        function downloadReceipt(receiptURL, fileName) {
            try {
                window.open(receiptURL, '_blank');
                console.log('Download initiated for:', fileName);
            } catch (error) {
                console.error('Error downloading receipt:', error);
                window.open(receiptURL, '_blank');
            }
        }

        async function viewReceipt(orderId) {
            try {
                const order = orders.find(o => o.id === orderId);
                if (!order || !order.receiptURL) {
                    alert('לא נמצאה קבלה עבור הזמנה זו');
                    return;
                }
                
                const isRequester = userRole === 'requester';
                
                document.getElementById('receiptModalTitle').textContent = isRequester ? 'צפייה/עריכת קבלה' : 'צפייה בקבלה';
                
                const receiptContent = document.getElementById('receiptContent');
                
                const isPDF = order.receiptFileName && order.receiptFileName.toLowerCase().endsWith('.pdf');
                
                let contentHTML = '';
                
                if (isPDF) {
                    contentHTML = `
                        <div class="receipt-viewer">
                            <div style="text-align: center; padding: 2rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 1rem;">
                                <h3>📄 קובץ PDF</h3>
                                <p style="margin: 1rem 0; color: var(--text-secondary);">${order.receiptFileName}</p>
                                <button class="btn btn-primary" onclick="window.open('${order.receiptURL}', '_blank')" style="margin: 0.5rem;">
                                    📖 פתח PDF בכרטיסייה חדשה
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    contentHTML = `
                        <div class="receipt-viewer">
                            <img src="${order.receiptURL}" alt="קבלה" class="receipt-image" style="max-width: 100%; height: auto;">
                            <p style="margin-top: 1rem; color: var(--text-secondary);">
                                ${order.receiptFileName || 'קבלה'}
                            </p>
                        </div>
                    `;
                }
                
                if (isRequester) {
                    contentHTML += `
                        <div class="file-upload">
                            <hr style="margin: 2rem 0;">
                            <h4 style="margin-bottom: 1rem;">החלפת קבלה</h4>
                            <input type="file" id="newReceiptFile" class="file-input" accept="image/*,.pdf">
                            <label for="newReceiptFile" class="file-upload-btn">
                                📁 בחר קבלה חדשה
                            </label>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-primary" id="replaceReceiptBtn" style="display: none;">
                                    🔄 החלף קבלה
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    contentHTML += `
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                            <p style="color: var(--text-secondary);">
                                הקבלה הועלתה בתאריך: ${formatDate(order.receiptUploadDate)}
                            </p>
                        </div>
                    `;
                }
                
                receiptContent.innerHTML = contentHTML;
                
                if (isRequester) {
                    const fileInput = document.getElementById('newReceiptFile');
                    const replaceBtn = document.getElementById('replaceReceiptBtn');
                    
                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            replaceBtn.style.display = 'block';
                            replaceBtn.onclick = async () => {
                                try {
                                    replaceBtn.disabled = true;
                                    replaceBtn.innerHTML = '<div class="loading"></div> מעלה...';
                                    
                                    const newFile = e.target.files[0];
                                    await uploadReceiptFile(orderId, newFile);
                                    
                                    closeReceiptModal();
                                } catch (error) {
                                    replaceBtn.disabled = false;
                                    replaceBtn.innerHTML = '🔄 החלף קבלה';
                                }
                            };
                        } else {
                            replaceBtn.style.display = 'none';
                        }
                    });
                }
                
                receiptModal.classList.add('active');
                
            } catch (error) {
                console.error('Error viewing receipt:', error);
                alert('שגיאה בטעינת הקבלה');
            }
        }

        window.uploadReceipt = function(orderId) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*,.pdf';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 10 * 1024 * 1024) {
                    alert('גודל הקובץ חייב להיות קטן מ-10MB');
                    return;
                }
                
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
                if (!validTypes.includes(file.type)) {
                    alert('סוג קובץ לא נתמך. אנא בחר תמונה או קובץ PDF');
                    return;
                }
                
                try {
                    await uploadReceiptFile(orderId, file);
                } catch (error) {
                    console.error('Error uploading receipt:', error);
                }
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        };

        // Utility functions
        function isUserApprover(approverName) {
            if (!userData.approverType) return false;
            
            const approverMap = {
                'אמילי': 'emily',
                'שולי': 'shuli',
                'גדי': 'gadi'
            };
            
            return approverMap[approverName] === userData.approverType;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        async function handleLogout() {
            if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            }
        }

        // Initialize app
        initApp();

        // Setup initial event listeners for cost calculation
        setTimeout(() => {
            const initialCostInput = document.querySelector('.cost-input');
            
            if (initialCostInput) {
                initialCostInput.addEventListener('input', updateOrderSummary);
                console.log('Initial cost input event listener added');
            }
        }, 500);

        // Make functions globally available
        window.removeOrderItem = removeOrderItem;
        window.viewReceipt = viewReceipt;
        window.downloadReceipt = downloadReceipt;
        
    </script>
</body>
</html>

